{% extends "base.html" %}

{% block title %}View Pin - PinBoard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card mb-4 pin-detail-card">
            {% if pin.image_url %}
            <img src="{{ pin.image_url }}" class="card-img-top pin-detail-image" alt="{{ pin.title }}">
            {% else %}
            <div class="card-img-top text-center bg-light py-5">
                <i class="fas fa-image fa-3x text-muted"></i>
            </div>
            {% endif %}
            <div class="card-body">
                <h5 class="card-title">{{ pin.title if pin.title else "Untitled Pin" }}</h5>
                <p class="card-text">{{ pin.tags }}</p>
                {% if pin.source_url %}
                <p><small class="text-muted">Source: <a href="{{ pin.source_url }}" target="_blank">{{ pin.source_url }}</a></small></p>
                {% endif %}
                <p class="text-muted">
                    Pinned by <a href="{{ url_for('frontend.user_profile', user_id=pin.user_id) }}">{{ pin.username }}</a> to 
                    <a href="{{ url_for('frontend.view_board', board_id=pin.board_id) }}">{{ pin.board_name }}</a>
                </p>
                
                <!-- Like/Unlike Button -->
                {% if user %}
                <form method="POST" action="{{ url_for('frontend.toggle_like', pin_id=pin.pin_id) }}" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-{{ 'danger' if user_liked else 'outline-danger' }}">
                        <i class="fas fa-heart"></i> {{ 'Unlike' if user_liked else 'Like' }}
                    </button>
                </form>
                {% endif %}
                
                <span class="badge bg-secondary">{{ like_count }} {{ 'like' if like_count == 1 else 'likes' }}</span>
                
                <!-- Repin dropdown for authenticated users -->
                {% if user and user.user_id != pin.user_id %}
                <div class="dropdown d-inline-block">
                    <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="repinDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-thumbtack"></i> Repin
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="repinDropdown">
                        {% if user_boards %}
                            <li><h6 class="dropdown-header">Select a board</h6></li>
                            {% for board in user_boards %}
                                <li>
                                    <form method="POST" action="{{ url_for('frontend.repin', pin_id=pin.pin_id) }}">
                                        <input type="hidden" name="board_id" value="{{ board.board_id }}">
                                        <button type="submit" class="dropdown-item">{{ board.name }}</button>
                                    </form>
                                </li>
                            {% endfor %}
                        {% else %}
                            <li><a class="dropdown-item" href="{{ url_for('frontend.create_board') }}">Create a board first</a></li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Comments Section -->
        <div class="card">
            <div class="card-header">
                <h5>Comments</h5>
            </div>
            <div class="card-body">
                {% if comments %}
                    <ul class="list-group list-group-flush">
                        {% for comment in comments %}
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>
                                            <a href="{{ url_for('frontend.user_profile', user_id=comment.user_id) }}">{{ comment.username }}</a>
                                        </strong>
                                        <p>{{ comment.comment_text }}</p>
                                    </div>
                                    <small class="text-muted">{{ comment.created_at.strftime('%b %d, %Y') }}</small>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No comments yet.</p>
                {% endif %}
                
                <!-- Comment Form for authenticated users -->
                {% if user %}
                    <form method="POST" action="{{ url_for('frontend.add_comment', pin_id=pin.pin_id) }}" class="mt-3">
                        <div class="mb-3">
                            <textarea class="form-control" name="comment_text" rows="2" placeholder="Add a comment..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Post Comment</button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Board Information</h5>
            </div>
            <div class="card-body">
                <h6><a href="{{ url_for('frontend.view_board', board_id=pin.board_id) }}">{{ pin.board_name }}</a></h6>
                <p>
                    <a href="{{ url_for('frontend.user_profile', user_id=pin.user_id) }}">{{ pin.username }}</a>
                </p>
                {% if user and user.user_id != pin.user_id %}
                  <form method="POST"
                        action="{{ url_for('frontend.toggle_follow', board_id=pin.board_id) }}">
                    {% if is_following %}
                        <button type="submit" class="btn btn-sm btn-success">
                            <i class="fas fa-check"></i> Unfollow Board
                        </button>
                    {% else %}
                        <button type="submit" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-plus"></i> Follow Board
                        </button>
                    {% endif %}
                  </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}